<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GravityRemote Mobile</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --bg-hover: #252525;
            --border: #1f1f1f;
            --text-primary: #33ff33;
            --text-secondary: #228822;
            --accent-green: #33ff33;
            --accent-green-dark: #22aa22;
            --accent-red: #ff3333;
            --font-mono: 'Courier New', 'Monaco', monospace;
            --font-digital: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-ui);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header - Ultra Compact */
        .header {
            background: var(--bg-secondary);
            padding: 4px 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-green);
            font-family: var(--font-mono);
            text-shadow: 0 0 8px var(--accent-green);
            cursor: pointer;
            user-select: none;
        }

        .brand::before {
            content: '◆';
            font-size: 20px;
        }

        /* Collapsible sections */
        .system-stats.collapsed,
        .control-panel.collapsed,
        .lisan-banners.collapsed {
            display: none;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 9px;
            font-family: var(--font-mono);
            color: var(--accent-green);
            text-shadow: 0 0 5px var(--accent-green);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-red);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--accent-green);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Control Panel - Snappy & Compact */
        .control-panel {
            padding: 6px 8px;
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .control-btn {
            flex: 1;
            padding: 6px 8px;
            border: none;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            backdrop-filter: blur(4px);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        /* Split button group */
        .btn-group {
            display: flex;
            flex: 1.5;
            gap: 1px;
        }

        .btn-group .control-btn {
            flex: 1;
            border-radius: 0;
        }

        .btn-group .control-btn:first-child {
            border-radius: 6px 0 0 6px;
        }

        .btn-group .control-btn:last-child {
            border-radius: 0 6px 6px 0;
        }

        .btn-start {
            background: rgba(17, 102, 17, 0.5);
            color: var(--accent-green);
            border: 1px solid rgba(34, 170, 34, 0.7);
            text-shadow: 0 0 6px var(--accent-green);
        }

        .btn-restart {
            background: rgba(34, 68, 34, 0.4);
            color: var(--accent-green);
            border: 1px solid rgba(34, 170, 34, 0.5);
            text-shadow: 0 0 4px var(--accent-green);
        }

        .btn-refresh {
            background: rgba(20, 40, 20, 0.5);
            color: var(--accent-green);
            border: 1px solid rgba(34, 170, 34, 0.4);
        }

        .btn-kill {
            background: rgba(34, 68, 34, 0.4);
            color: var(--accent-green);
            border: 1px solid rgba(34, 170, 34, 0.5);
        }

        .btn-agent {
            background: rgba(17, 68, 17, 0.5);
            color: var(--accent-green);
            border: 1px solid rgba(34, 170, 34, 0.6);
            text-shadow: 0 0 5px var(--accent-green);
        }

        /* Stop button - small, matrix-green themed */
        .btn-stop {
            flex: 0 0 auto;
            padding: 6px 10px;
            background: rgba(40, 20, 20, 0.6);
            color: #ff6666;
            border: 1px solid rgba(255, 100, 100, 0.4);
            font-size: 14px;
            border-radius: 6px;
        }

        .btn-stop:hover {
            background: rgba(60, 20, 20, 0.8);
            box-shadow: 0 0 8px rgba(255, 100, 100, 0.3);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-top: 1px solid var(--border);
        }

        .chat-header {
            padding: 4px 10px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-green);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-mono);
            text-shadow: 0 0 5px var(--accent-green);
        }

        /* System Stats - 80s Digital */
        .system-stats {
            padding: 4px 10px;
            background: #050505;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: center;
            gap: 20px;
            font-family: var(--font-digital);
            font-size: 11px;
            color: var(--accent-green);
            text-shadow: 0 0 10px var(--accent-green);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            color: var(--accent-green-dark);
            font-size: 9px;
        }

        .stat-value {
            font-weight: bold;
            letter-spacing: 1px;
        }

        .agent-frame-wrapper {
            flex: 1;
            overflow: hidden;
            background: var(--bg-primary);
        }

        .agent-frame-wrapper iframe {
            width: 100%;
            height: 100%;
            border: none;
            filter: invert(0.88) hue-rotate(180deg);
        }

        /* Footer - Hidden for more space */
        .footer {
            display: none;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            border: 1px solid var(--border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--accent-orange);
        }

        .modal-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-cancel {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-confirm {
            background: var(--accent-orange);
            color: white;
        }

        /* Loading Spinner */
        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-secondary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner.active {
            display: inline-block;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Header Right Section */
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .agent-badge {
            font-size: 9px;
            font-family: var(--font-mono);
            color: var(--accent-green);
            text-shadow: 0 0 5px var(--accent-green);
            text-transform: uppercase;
        }

        text-shadow: 0 0 8px var(--accent-green);
        }

        .stat-compact {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .stat-label-tiny {
            font-size: 8px;
            color: #666;
            font-family: var(--font-mono);
        }

        .stat-val-tiny {
            font-size: 9px;
            color: var(--accent-green);
            font-family: var(--font-digital);
            min-width: 25px;
            text-align: right;
        }

        /* Lisan al-Arab Scrolling Text - Block System */
        .lisan-banners {
            background: #080808;
            /* Slightly lighter/richer black */
            border-bottom: 1px solid var(--border);
            height: 38px;
            /* Compact height */
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
        }

        .lisan-marquee-container {
            display: flex;
            flex-direction: row;
            /* RTL handled by order or direction */
            direction: rtl;
            /* Sets the flow: Item 1 on Right, Item 2 Left */
            position: absolute;
            white-space: nowrap;
            height: 100%;
            align-items: center;
            will-change: transform;
        }

        .word-block {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            /* Tighter spacing */
            flex-shrink: 0;
            padding-bottom: 2px;
            /* Visual balance */
        }

        .word-arabic {
            font-size: 16px;
            /* +1px */
            font-family: 'Amiri', 'Traditional Arabic', 'Scheherazade', serif;
            color: var(--accent-green);
            text-shadow: 0 0 10px var(--accent-green);
            line-height: 1;
            margin-bottom: 0px;
            /* No gap */
        }

        .word-latin {
            font-size: 9px;
            /* +1px */
            font-family: var(--font-mono);
            color: #22cc22;
            /* Slightly darker/different green for contrast */
            text-shadow: 0 0 5px #22cc22;
            letter-spacing: 0.5px;
            line-height: 1;
            direction: ltr;
            /* Internal text direction for reversed chars (m-a-l-a-s) */
        }

        .lisan-separator {
            color: rgba(50, 255, 100, 0.6);
            text-shadow: 0 0 8px rgba(50, 255, 100, 0.8);
            font-size: 10px;
            margin: 0 15px;
        }

        /* Model Popup Dropdown */
        .model-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 100px;
        }

        .model-popup-content {
            background: var(--bg-secondary);
            border: 1px solid var(--accent-green);
            border-radius: 10px;
            min-width: 280px;
            max-width: 90%;
            box-shadow: 0 0 20px rgba(50, 255, 50, 0.3);
        }

        .model-option {
            padding: 14px 18px;
            color: var(--accent-green);
            font-size: 13px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .model-option:first-child {
            border-radius: 10px 10px 0 0;
        }

        .model-option:last-child {
            border-bottom: none;
            border-radius: 0 0 10px 10px;
        }

        .model-option:hover,
        .model-option:active {
            background: rgba(50, 255, 50, 0.15);
        }

        .collapsed {
            display: none !important;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header class="header">
        <div class="brand" id="brand-toggle" onclick="toggleHeaders()">◆ GRAVITYREMOTE</div>
        <div class="header-right">
            <!-- CPU/RAM Compact -->
            <div class="stat-compact">
                <span class="stat-label-tiny">CPU</span>
                <span class="stat-val-tiny" id="cpu-stat">--%</span>
            </div>
            <div class="stat-compact">
                <span class="stat-label-tiny">RAM</span>
                <span class="stat-val-tiny" id="ram-stat">--MB</span>
            </div>

            <span class="agent-badge">Agent</span>
            <span id="conn-label" class="live-badge">●</span>
            <div class="status-badge">
                <div id="status-dot" class="status-dot"></div>
            </div>
        </div>
    </header>

    <!-- System Stats moved to Header -->

    <!-- Control Panel -->
    <div class="control-panel">
        <div class="btn-group">
            <button class="control-btn btn-start" onclick="startIDE()">
                IDE Start
            </button>
            <button class="control-btn btn-kill" onclick="toggleModelPopup()">
                ▾ Model
            </button>
        </div>
        <button class="control-btn btn-agent" onclick="openAgentMode()">
            ⌨ AGENT
        </button>
        <button class="control-btn btn-restart" onclick="showRestartModal()">
            ⟳ Reload
        </button>
        <button class="control-btn btn-refresh" onclick="refreshFrame()">
            ↻ Refresh
        </button>
    </div>

    <!-- Model Popup Dropdown -->
    <div id="model-popup" class="model-popup" style="display: none;">
        <div class="model-popup-content">
            <div class="model-option" onclick="selectModel(0, 'Gemini 3 Pro (High)')">Gemini 3 Pro (High)</div>
            <div class="model-option" onclick="selectModel(1, 'Gemini 3 Pro (Low)')">Gemini 3 Pro (Low)</div>
            <div class="model-option" onclick="selectModel(2, 'Gemini 3 Flash')">Gemini 3 Flash <span
                    style="color:#0f0;font-size:8px">NEW</span></div>
            <div class="model-option" onclick="selectModel(3, 'Claude Sonnet 4.5')">Claude Sonnet 4.5</div>
            <div class="model-option" onclick="selectModel(4, 'Claude Sonnet 4.5 (Thinking)')">Claude Sonnet 4.5
                (Thinking)</div>
            <div class="model-option" onclick="selectModel(5, 'Claude Opus 4.5 (Thinking)')">Claude Opus 4.5 (Thinking)
            </div>
            <div class="model-option" onclick="selectModel(6, 'GPT-OSS 120B (Medium)')">GPT-OSS 120B (Medium)</div>
        </div>
    </div>

    <!-- Agent Chat -->
    <div class="chat-container">
        <!-- Lisan al-Arab Scrolling Text - Block System -->
        <div class="lisan-banners">
            <div id="lisan-marquee" class="lisan-marquee-container">
                <!-- Word Blocks Injected Here -->
            </div>
        </div>
        <div class="agent-frame-wrapper">
            <iframe id="agent-frame" src="" allow="clipboard-read; clipboard-write"></iframe>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        Mobile Remote v1.0 • Port 8893 • Dark Mode
    </div>

    <!-- Restart Modal -->
    <div id="restart-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">⟳ Restart Antigravity IDE</div>
            <div class="modal-text">
                This will restart the Antigravity IDE process. The connection may be temporarily interrupted.
                <br><br>
                Are you sure you want to continue?
            </div>
            <div class="modal-actions">
                <button class="modal-cancel" onclick="hideRestartModal()">Cancel</button>
                <button class="modal-confirm" onclick="restartIDE()">
                    <span id="restart-spinner" class="spinner"></span>
                    <span id="restart-text">Restart</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        const agentFrame = document.getElementById('agent-frame');
        const statusDot = document.getElementById('status-dot');
        // const statusText = document.getElementById('status-text'); // Removed
        const connLabel = document.getElementById('conn-label');

        // Use the server hostname instead of 127.0.0.1
        const PROXY_HOST = window.location.hostname;
        const PROXY_PORT = 8892;
        const PROXY_URL = `http://${PROXY_HOST}:${PROXY_PORT}`;

        // Set iframe source on load
        agentFrame.src = PROXY_URL;

        // Check connection status
        function checkConnection() {
            fetch(PROXY_URL, { mode: 'no-cors' })
                .then(() => {
                    statusDot.classList.add('connected');
                    connLabel.textContent = '●';
                    connLabel.style.color = 'var(--accent-green)';
                })
                .catch(() => {
                    statusDot.classList.remove('connected');
                    connLabel.textContent = '○';
                    connLabel.style.color = 'var(--accent-red)';
                });
        }

        // Fetch and display system stats (80s style)
        async function updateSystemStats() {
            try {
                const response = await fetch('/api/stats');
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('cpu-stat').textContent = stats.cpu + '%';
                    document.getElementById('ram-stat').textContent = stats.ram + 'MB';
                }
            } catch (e) {
                document.getElementById('cpu-stat').textContent = 'ERR';
                document.getElementById('ram-stat').textContent = 'ERR';
            }
        }

        // Refresh the agent frame
        function refreshFrame() {
            agentFrame.src = PROXY_URL;
            showToast('REFRESHING...');
        }

        // Start IDE (when not running)
        async function startIDE() {
            showToast('STARTING IDE...');
            try {
                const response = await fetch('/api/start-ide', { method: 'POST' });
                if (response.ok) {
                    showToast('IDE STARTING');
                    setTimeout(() => {
                        agentFrame.src = PROXY_URL;
                    }, 3000);
                } else {
                    showToast('START FAIL');
                }
            } catch (e) {
                showToast('START SIGNAL SENT');
                setTimeout(() => {
                    agentFrame.src = PROXY_URL;
                }, 3000);
            }
        }

        // Kill IDE (kill all antigravity processes)
        async function killIDE() {
            showToast('KILLING IDE...');
            try {
                const response = await fetch('/api/kill-ide', { method: 'POST' });
                if (response.ok) {
                    showToast('IDE KILLED');
                } else {
                    showToast('KILL FAIL');
                }
            } catch (e) {
                showToast('KILL SIGNAL SENT');
            }
        }

        // Open Agent Mode (send Ctrl+E to IDE)
        async function openAgentMode() {
            showToast('ACTIVATING AGENT...');
            try {
                const response = await fetch('/api/agent-mode', { method: 'POST' });
                if (response.ok) {
                    showToast('AGENT MODE ON');
                    setTimeout(() => {
                        agentFrame.src = PROXY_URL;
                    }, 1000);
                } else {
                    showToast('AGENT FAIL');
                }
            } catch (e) {
                showToast('SIGNAL SENT');
            }
        }

        // Stop Agent operation
        async function stopAgent() {
            showToast('STOPPING...');
            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                if (response.ok) {
                    showToast('STOPPED');
                } else {
                    showToast('STOP FAIL');
                }
            } catch (e) {
                showToast('STOP SIGNAL SENT');
            }
        }

        // Model Popup Functions
        function toggleModelPopup() {
            const popup = document.getElementById('model-popup');
            popup.style.display = popup.style.display === 'none' ? 'flex' : 'none';
        }

        function hideModelPopup() {
            document.getElementById('model-popup').style.display = 'none';
        }

        // Select model and send to server
        async function selectModel(index, name) {
            hideModelPopup();
            showToast(`SWITCHING TO ${name}...`);

            try {
                const response = await fetch('/api/set-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index, name })
                });
                if (response.ok) {
                    showToast(`✓ ${name}`);
                    setTimeout(() => refreshFrame(), 500);
                } else {
                    showToast('MODEL SWITCH FAIL');
                }
            } catch (e) {
                showToast('SIGNAL SENT');
            }
        }

        // Close popup on background click
        document.addEventListener('click', function (e) {
            const popup = document.getElementById('model-popup');
            if (e.target === popup) {
                hideModelPopup();
            }
        });

        // Show restart modal
        function showRestartModal() {
            document.getElementById('restart-modal').classList.add('active');
        }

        // Hide restart modal
        function hideRestartModal() {
            document.getElementById('restart-modal').classList.remove('active');
        }

        // Restart IDE
        async function restartIDE() {
            const spinner = document.getElementById('restart-spinner');
            const text = document.getElementById('restart-text');

            spinner.classList.add('active');
            text.textContent = 'RESTARTING...';

            try {
                const response = await fetch('/api/restart-ide', { method: 'POST' });
                if (response.ok) {
                    showToast('IDE RESTART OK');
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                } else {
                    showToast('RESTART FAIL');
                }
            } catch (e) {
                showToast('SIGNAL SENT');
                setTimeout(() => {
                    window.location.reload();
                }, 5000);
            }

            hideRestartModal();
            spinner.classList.remove('active');
            text.textContent = 'RESTART';
        }

        // Show toast message
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Toggle headers visibility
        let headersCollapsed = false;
        function toggleHeaders() {
            headersCollapsed = !headersCollapsed;
            // .system-stats removed
            const controlPanel = document.querySelector('.control-panel');
            if (controlPanel) controlPanel.classList.toggle('collapsed', headersCollapsed);

            const lisanBanners = document.querySelector('.lisan-banners');
            if (lisanBanners) lisanBanners.classList.toggle('collapsed', headersCollapsed);
        }

        // Initialize
        checkConnection();
        updateSystemStats();
        setInterval(checkConnection, 10000);
        setInterval(updateSystemStats, 3000);

        // ========================================
        // لِسَان العَرَب - Lisan al-Arab Streaming
        // ========================================

        // Lisan al-Arab sentences (Dynamic Fetch)
        let lisanSentences = [
            "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ"
        ];

        // Fetch Lisan data from server
        async function fetchLisanData() {
            try {
                const response = await fetch('/api/lisan');
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        lisanSentences = data;
                        currentLisanIndex = 0;
                        updateLisanBanners();
                        console.log('Lisan data loaded:', data.length);
                    }
                }
            } catch (e) {
                console.error('Failed to fetch Lisan data:', e);
            }
        }

        // Initial Fetch
        fetchLisanData();

        // Refresh data every 60 seconds
        setInterval(fetchLisanData, 60000);

        // Arabic consonants to Latin transliteration map
        const consonantMap = {
            'ا': 'ā', 'أ': 'a', 'إ': 'i', 'آ': 'ā',
            'ب': 'b', 'ت': 't', 'ث': 'th',
            'ج': 'j', 'ح': 'ḥ', 'خ': 'kh',
            'د': 'd', 'ذ': 'dh',
            'ر': 'r', 'ز': 'z',
            'س': 's', 'ش': 'sh',
            'ص': 'ṣ', 'ض': 'ḍ',
            'ط': 'ṭ', 'ظ': 'ẓ',
            'ع': 'ʿ', 'غ': 'gh',
            'ف': 'f', 'ق': 'q',
            'ك': 'k', 'ل': 'l',
            'م': 'm', 'ن': 'n',
            'ه': 'h', 'و': 'w',
            'ي': 'y', 'ى': 'ā',
            'ء': 'ʾ', 'ة': 'h',
            'ـ': '', // Tatweel (kashida)
        };

        // Arabic diacritics mapped to Unicode combining diacritics for Latin
        // These go ABOVE the previous Latin letter
        const diacriticMap = {
            'َ': 'a',   // Fatha → a
            'ِ': 'i',   // Kasra → i
            'ُ': 'u',   // Damma → u
            'ً': 'an',  // Fathatan → an
            'ٍ': 'in',  // Kasratan → in
            'ٌ': 'un',  // Dammatan → un
            'ْ': '',    // Sukun → nothing
            'ّ': '',    // Shadda → handled separately (double consonant)
        };

        // Check if character is an Arabic diacritic
        function isDiacritic(char) {
            return 'ًٌٍَُِّْ'.includes(char);
        }

        // Transliterate specific word
        // Returns the Latin string with characters reversed for visual RTL alignment
        function transliterateWord(word) {
            let result = '';
            const chars = [...word];

            for (let i = 0; i < chars.length; i++) {
                const char = chars[i];

                if (isDiacritic(char)) continue;

                // Simple punctuation pass-through
                if (',.،؟:;'.includes(char)) {
                    result += char;
                    continue;
                }

                let latin = consonantMap[char];
                if (latin === undefined) {
                    result += char;
                    continue;
                }

                let j = i + 1;
                while (j < chars.length && isDiacritic(chars[j])) {
                    const diac = chars[j];
                    if (diac === 'ّ') {
                        latin = latin + latin;
                    } else if (diacriticMap[diac]) {
                        latin = latin + diacriticMap[diac];
                    }
                    j++;
                }

                result += latin;
            }
            // Reverse the letters for RTL match ("salam" -> "malas")
            return [...result].reverse().join('');
        }

        // Current sentence index
        let currentLisanIndex = 0;

        // Create a DOM element for a word block
        function createWordBlock(arabic, latin) {
            const block = document.createElement('div');
            block.className = 'word-block';
            // Mark as content block for width calculation if needed
            block.dataset.type = 'word';

            const arSpan = document.createElement('div');
            arSpan.className = 'word-arabic';
            arSpan.textContent = arabic;

            const laSpan = document.createElement('div');
            laSpan.className = 'word-latin';
            laSpan.textContent = latin;

            block.appendChild(arSpan);
            block.appendChild(laSpan);
            return block;
        }

        function createSeparator() {
            const sep = document.createElement('div');
            sep.className = 'lisan-separator';
            sep.dataset.type = 'separator';
            sep.textContent = '◆';
            return sep;
        }

        // State for Endless Stream
        const marqueeContainer = document.getElementById('lisan-marquee');
        // Force LTR for physics control, blocks keep internal alignment
        if (marqueeContainer) marqueeContainer.style.direction = 'ltr';

        // Start scroll at negative buffer so we have room to drive right
        // Actually, we can start at 0 and prepend.
        let currentScroll = 0;
        const SCROLL_SPEED = 32; // px per second
        let lastTime = performance.now();
        let isInitialized = false;

        // Create a fragment of a sentence
        function createSentenceFragment(sentence) {
            const words = sentence.split(' ').reverse();
            const fragment = document.createDocumentFragment();

            // Add Separator
            fragment.appendChild(createSeparator());

            words.forEach(word => {
                if (!word.trim()) return;
                const latin = transliterateWord(word);
                fragment.appendChild(createWordBlock(word, latin));
            });
            return fragment;
        }

        // Add to the Left (Start) - Logic for L->R stream source
        function prependNextSentence() {
            if (!lisanSentences.length) return;

            const sentence = lisanSentences[currentLisanIndex];
            const fragment = createSentenceFragment(sentence);

            // Measure width precisely using BoundingRect
            const oldRect = marqueeContainer.getBoundingClientRect();
            const oldWidth = oldRect.width;

            const firstChild = marqueeContainer.firstChild;
            if (firstChild) {
                marqueeContainer.insertBefore(fragment, firstChild);
            } else {
                marqueeContainer.appendChild(fragment);
            }

            // Immediate check of new width
            const newRect = marqueeContainer.getBoundingClientRect();
            const newWidth = newRect.width;
            const addedWidth = newWidth - oldWidth;

            // Adjust scroll with sub-pixel precision
            currentScroll -= addedWidth;

            // Cycle Index
            currentLisanIndex = (currentLisanIndex + 1) % lisanSentences.length;
        }

        // Main Animation Loop
        function animateStream(currentTime) {
            if (!marqueeContainer) return;

            const deltaTime = (currentTime - lastTime) / 1000;
            const dt = Math.min(deltaTime, 0.1);
            lastTime = currentTime;

            // Move Right
            currentScroll += SCROLL_SPEED * dt;

            // 1. Check if we need to fill the LEFT side (Source)
            // If currentScroll > -Buffer, we are running out of content on the left.
            // (Since we want content at negative coordinates flowing in)
            if (currentScroll > -200) {
                prependNextSentence();
            }

            // 2. Cleanup RIGHT side (Exit)
            // Get parent viewport width
            const viewportWidth = marqueeContainer.parentElement.offsetWidth;
            const lastChild = marqueeContainer.lastElementChild;

            if (lastChild) {
                // Determine if lastChild is fully off-screen to the right
                // Element visual Left = (ContainerVisualLeft + ElementOffsetLeft)
                // ContainerVisualLeft = currentScroll.
                // But let's use performant relative check.
                // lastChild.offsetLeft is relative to container start.

                const visualLeft = lastChild.offsetLeft + currentScroll;

                if (visualLeft > viewportWidth) {
                    marqueeContainer.removeChild(lastChild);
                }
            }

            // Apply Transform
            marqueeContainer.style.transform = `translate3d(${currentScroll}px, 0, 0)`; // use 3d for GPU

            requestAnimationFrame(animateStream);
        }

        // Initialize
        function initStream() {
            if (isInitialized) return;
            isInitialized = true;

            // Fill initially to cover screen + left buffer
            // We want enough content on the LEFT so that currentScroll can be e.g. -2000
            // and we still see content at 0.

            // Build up content until width > viewport * 2
            while (marqueeContainer.getBoundingClientRect().width < window.innerWidth * 2) {
                prependNextSentence();
            }

            // Set start position:
            // We want the stream to be visible, filling the screen.
            // visual connection: aligns the "Rightmost" part of our negative-space content to the right edge of screen?
            // "Left to Right" stream means content enters Left, moves Right.
            // So we want to populate the Left off-screen area.
            // Let's set currentScroll such that the RIGHT END of the content is at the RIGHT EDGE of viewport?
            // Or just ensure we have content covering 0..Viewport.
            // Since we `prepend`, the "End" of the DOM (lastChild) is the First thing we added.
            // The "Start" of the DOM (firstChild) is the Last thing we added (Newest).
            // We want the content to flow from Left.
            // So we need content at Negative visual space.
            // Container 0..2000.
            // If currentScroll = -2000. Visual range is -2000..0. Screen is empty (all left).
            // If currentScroll = -1500. Visual range -1500..500.
            // We see content from offset 1500 to 2000 (roughly).
            // This is the "Oldest" content (First added).
            // As currentScroll increases (-1499...), content moves Right.
            // Correct.

            // So initialize currentScroll to: -ContainerWidth + ViewportWidth?
            // Or just -ContainerWidth to start filling from emptiness?
            // Use -ContainerWidth + ViewportWidth to fill screen immediately.

            const width = marqueeContainer.getBoundingClientRect().width;
            currentScroll = -width + window.innerWidth;

            requestAnimationFrame(animateStream);
        }

        // Trigger
        function updateLisanBanners() {
            if (!isInitialized && lisanSentences.length > 0) {
                initStream();
            }
        }

        updateLisanBanners();
    </script>
</body>

</html>